# Claude Code Workflows for OTTER: ELITE FORCE
#
# Comprehensive AI-powered automation including:
# - Interactive @claude mentions
# - Automatic PR code review
# - CI failure auto-fix
# - Issue triage and labeling
# - Weekly maintenance
# - Security reviews
#
# Security: Only trusted users can trigger interactive mode

name: Claude Code

on:
  # Interactive: @claude mentions
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  issues:
    types: [opened, assigned, labeled]

  # Automatic: PR review
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

  # Scheduled: Weekly maintenance
  schedule:
    - cron: "0 0 * * 0" # Every Sunday at midnight UTC

  # Manual trigger for maintenance
  workflow_dispatch:
    inputs:
      task:
        description: "Task to run"
        required: true
        type: choice
        options:
          - maintenance
          - security-audit
          - dependency-update
        default: "maintenance"

jobs:
  # ============================================
  # INTERACTIVE MODE: @claude mentions
  # ============================================
  claude-interactive:
    name: Claude Interactive
    if: |
      (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
        (github.event_name == 'issues' && github.event.action == 'opened' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
      ) && (
        (
          (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
          (
            github.event.comment.author_association == 'OWNER' ||
            github.event.comment.author_association == 'MEMBER' ||
            github.event.comment.author_association == 'COLLABORATOR' ||
            github.event.sender.login == github.repository_owner
          )
        ) ||
        (
          github.event_name == 'pull_request_review' &&
          (
            github.event.review.author_association == 'OWNER' ||
            github.event.review.author_association == 'MEMBER' ||
            github.event.review.author_association == 'COLLABORATOR' ||
            github.event.sender.login == github.repository_owner
          )
        ) ||
        (
          github.event_name == 'issues' &&
          (
            github.event.sender.login == github.repository_owner ||
            github.event.issue.user.login == github.repository_owner
          )
        )
      )
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium
        continue-on-error: true

      - name: Run Claude Code
        uses: anthropics/claude-code-action@7145c3e0510bcdbdd29f67cc4a8c1958f1acfa2f # v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          additional_permissions: |
            actions: read

          claude_args: |
            --allowedTools "Edit,MultiEdit,Write,Read,Glob,Grep,LS,Bash(pnpm:*),Bash(npm:*),Bash(npx:*),Bash(node:*),Bash(bun:*),Bash(git:*),Bash(gh:*),Bash(cat:*),Bash(ls:*),Bash(head:*),Bash(tail:*),Bash(grep:*),Bash(rg:*),Bash(find:*),Bash(mkdir:*),Bash(rm:*),Bash(cp:*),Bash(mv:*),Bash(touch:*),Bash(chmod:*),Bash(echo:*),Bash(curl:*),Bash(which:*),Bash(pwd:*),Bash(wc:*),Bash(sort:*),Bash(uniq:*),Bash(sed:*),Bash(awk:*),Bash(xargs:*),Bash(tee:*),Bash(diff:*),Bash(tree:*),Bash(jq:*),Bash(biome:*),Bash(tsc:*),Bash(vitest:*),Bash(playwright:*),Bash(vite:*),WebFetch,NotebookEditCell"

  # ============================================
  # AUTO PR REVIEW: With progress tracking
  # ============================================
  claude-review:
    name: Claude PR Review
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Run Claude PR Review
        uses: anthropics/claude-code-action@7145c3e0510bcdbdd29f67cc4a8c1958f1acfa2f # v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true
          allowed_bots: "*"
          additional_permissions: |
            actions: read

          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            ## Project: OTTER: ELITE FORCE

            Mobile-first 3D tactical shooter with:
            - React 19 + TypeScript (strict)
            - Three.js via React Three Fiber
            - Yuka AI (steering, state machines)
            - Zustand state management
            - Tone.js procedural audio
            - Biome linting, Vitest tests, Playwright E2E

            ## Review Checklist

            ### Code Quality
            - [ ] TypeScript types properly defined (no 'any')
            - [ ] React hooks follow best practices
            - [ ] Three.js resources disposed correctly
            - [ ] Event listeners cleaned up

            ### Performance (Mobile Critical)
            - [ ] No unnecessary re-renders
            - [ ] Heavy computations memoized
            - [ ] InstancedMesh for repeated objects
            - [ ] Materials/geometries reused

            ### Testing
            - [ ] Unit tests for new logic
            - [ ] E2E tests for UI changes

            ### Procedural Generation
            - [ ] No external asset files
            - [ ] Audio synthesized via Web Audio
            - [ ] Models from Three.js primitives

            Use inline comments for specific issues.
            Post summary with checklist results.

          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Read,Glob,Grep,LS,Bash(gh:*),Bash(git diff:*),Bash(git log:*),Bash(git show:*),Bash(cat:*),Bash(ls:*),Bash(rg:*),Bash(biome:*),Bash(tsc:*)"

  # ============================================
  # ISSUE TRIAGE: Auto-label new issues
  # ============================================
  claude-triage:
    name: Claude Issue Triage
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1

      - name: Triage Issue
        uses: anthropics/claude-code-action@7145c3e0510bcdbdd29f67cc4a8c1958f1acfa2f # v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          allowed_non_write_users: "*"
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            REPO: ${{ github.repository }}
            ISSUE NUMBER: ${{ github.event.issue.number }}
            TITLE: ${{ github.event.issue.title }}
            BODY: ${{ github.event.issue.body }}
            AUTHOR: ${{ github.event.issue.user.login }}

            ## Project: OTTER: ELITE FORCE
            A 3D tactical shooter game with otters fighting predators.

            ## Triage Instructions

            Analyze this issue and determine:
            1. **Type**: bug, feature, enhancement, question, documentation
            2. **Area**: gameplay, ui, audio, ai, performance, testing, build, mobile
            3. **Priority**: P1 (critical), P2 (high), P3 (medium/low)

            ## Label Mapping
            - Bug reports → "bug"
            - Feature requests → "enhancement"
            - Questions → "question"
            - Gameplay related → "gameplay"
            - UI/UX issues → "ui"
            - Audio issues → "audio"
            - AI/Enemy behavior → "ai"
            - Performance → "performance"
            - Mobile specific → "mobile"

            Add appropriate labels using:
            `gh issue edit ${{ github.event.issue.number }} --add-label "label1,label2"`

            If it's a question, add a helpful comment.
            If it might be a duplicate, search existing issues and mention them.

          claude_args: |
            --allowedTools "Read,Bash(gh issue:*),Bash(gh search:*)"

  # ============================================
  # WEEKLY MAINTENANCE: Scheduled health check
  # ============================================
  claude-maintenance:
    name: Claude Weekly Maintenance
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.task == 'maintenance')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Maintenance Check
        uses: anthropics/claude-code-action@7145c3e0510bcdbdd29f67cc4a8c1958f1acfa2f # v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          prompt: |
            REPO: ${{ github.repository }}

            ## Weekly Maintenance Tasks

            Perform these maintenance checks:

            1. **Dependency Audit**
               - Run `pnpm audit` to check for vulnerabilities
               - Check for outdated packages with `pnpm outdated`

            2. **Code Health**
               - Run `pnpm run lint` and report any issues
               - Run `pnpm run typecheck` for type errors
               - Check for TODO/FIXME comments: `rg "TODO|FIXME" src/`

            3. **Test Health**
               - Run `pnpm run test:unit` and report results
               - Check test coverage

            4. **Issue Hygiene**
               - List issues older than 30 days: `gh issue list --state open --json number,title,createdAt`
               - Identify stale issues that need attention

            5. **Documentation**
               - Verify README.md is up to date
               - Check if CHANGELOG.md needs updating

            Create a single issue titled "Weekly Maintenance Report - [DATE]" summarizing all findings.
            Use checkboxes for actionable items.
            Tag critical issues as high priority.

          claude_args: |
            --allowedTools "Read,Glob,Grep,LS,Bash(pnpm:*),Bash(npm:*),Bash(gh:*),Bash(git:*),Bash(rg:*),Bash(cat:*),Bash(ls:*)"

  # ============================================
  # SECURITY AUDIT: Manual trigger
  # ============================================
  claude-security:
    name: Claude Security Audit
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.task == 'security-audit'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      security-events: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Security Audit
        uses: anthropics/claude-code-action@7145c3e0510bcdbdd29f67cc4a8c1958f1acfa2f # v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          prompt: |
            REPO: ${{ github.repository }}

            ## Comprehensive Security Audit

            Perform a thorough security review of this codebase:

            ### 1. Dependency Security
            - Run `pnpm audit` and analyze results
            - Check for known vulnerable packages
            - Review dependency tree for suspicious packages

            ### 2. Code Security
            - **Secrets**: Search for hardcoded API keys, tokens, passwords
              `rg -i "(api.?key|secret|password|token|credential)" --type ts`
            - **XSS**: Check for dangerous innerHTML or dangerouslySetInnerHTML
            - **Injection**: Look for unsanitized user input
            - **localStorage**: Verify sensitive data handling

            ### 3. Game-Specific Security
            - Verify save data validation in gameStore
            - Check for client-side score manipulation vectors
            - Review localStorage schema migration

            ### 4. Build Security
            - Check for exposed source maps in production
            - Verify environment variable handling
            - Review CSP headers in render.yaml

            ### 5. CI/CD Security
            - Review GitHub Actions for secret exposure
            - Check workflow permissions are minimal

            Create a detailed security report as a GitHub issue.
            Rate each finding: CRITICAL, HIGH, MEDIUM, LOW, INFO
            Provide specific remediation steps.

          claude_args: |
            --allowedTools "Read,Glob,Grep,LS,Bash(pnpm:*),Bash(gh:*),Bash(rg:*),Bash(cat:*),Bash(ls:*),Bash(git:*)"

  # ============================================
  # DEPENDENCY UPDATE: Manual trigger
  # ============================================
  claude-deps:
    name: Claude Dependency Update
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.task == 'dependency-update'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 20
          cache: "pnpm"

      - name: Update Dependencies
        uses: anthropics/claude-code-action@7145c3e0510bcdbdd29f67cc4a8c1958f1acfa2f # v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}

          prompt: |
            REPO: ${{ github.repository }}

            ## Dependency Update Task

            Update project dependencies safely:

            1. **Check Current State**
               - Run `pnpm outdated` to see what needs updating
               - Run `pnpm audit` to check for security issues

            2. **Update Strategy**
               - Update patch versions first (safest)
               - Then minor versions
               - Major versions need careful review

            3. **Safe Updates** (do these)
               - Security patches (always)
               - Patch versions of all dependencies
               - Minor versions of dev dependencies

            4. **Careful Updates** (review changelog first)
               - Minor versions of runtime dependencies
               - Any React Three Fiber ecosystem updates

            5. **After Updates**
               - Run `pnpm install`
               - Run `pnpm run typecheck` to verify types
               - Run `pnpm run lint` to check for issues
               - Run `pnpm run build` to verify build works
               - Run `pnpm run test:unit` to verify tests pass

            6. **Create PR**
               - Commit changes to a new branch
               - Create a PR with detailed changelog of updates
               - List any breaking changes or migration notes

          claude_args: |
            --allowedTools "Edit,Write,Read,Glob,Grep,LS,Bash(pnpm:*),Bash(npm:*),Bash(git:*),Bash(gh:*),Bash(cat:*),Bash(ls:*),Bash(rg:*)"
