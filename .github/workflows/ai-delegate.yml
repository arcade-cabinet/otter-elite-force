name: AI Command Handler

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  claude-command:
    name: Handle @claude Command
    if: contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract Command
        id: command
        run: |
          BODY="${{ github.event.comment.body }}"
          # Extract everything after @claude
          CMD=$(echo "$BODY" | sed 's/.*@claude[[:space:]]*//' | head -1)
          echo "task=$CMD" >> $GITHUB_OUTPUT
          echo "Command: $CMD"

      - name: Execute Claude Task
        if: secrets.ANTHROPIC_API_KEY != ''
        uses: anthropics/claude-code-action@main
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          allowed_tools: "Read,Glob,Grep,Edit,Write,LS,Bash(git),Bash(npm),Bash(pnpm),Bash(yarn),Bash(python),Bash(node)"
          direct_prompt: |
            The user requested: ${{ steps.command.outputs.task }}

            If this is a code change request:
            1. Make the requested changes
            2. Test if possible
            3. Create a commit with a clear message
            4. Push to the current branch

            If this is a question/analysis:
            1. Analyze the code
            2. Post findings as a comment on the issue/PR

            PR/Issue: #${{ github.event.issue.number }}

  sage-command:
    name: Handle @sage Command
    if: contains(github.event.comment.body, '@sage') || contains(github.event.comment.body, '/sage')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Extract Query
        id: query
        run: |
          BODY="${{ github.event.comment.body }}"
          QUERY=$(echo "$BODY" | sed 's/.*@sage[[:space:]]\|.*\/sage[[:space:]]//')
          echo "question=$QUERY" >> $GITHUB_OUTPUT

      - name: Answer Question
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸ§™ Sage Response:\n\nQuestion: ${{ steps.query.outputs.question }}\n\nPlease provide context or let @claude handle this for deeper analysis.`
            })
