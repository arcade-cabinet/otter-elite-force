<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OTTER: ELITE FORCE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Carter+One&family=Varela+Round&display=swap');

        :root { 
            --primary: #ffaa00; 
            --accent: #00ccff; 
            --ui-bg: rgba(20, 15, 10, 0.95);
        }

        body { margin: 0; overflow: hidden; background-color: #000; touch-action: none; font-family: 'Varela Round', sans-serif; user-select: none; -webkit-user-select: none; color: #eee; }
        
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        
        #scanlines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px; opacity: 0.4;
        }

        /* LOAD SCREEN */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s; pointer-events: none;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* SCREENS LAYER */
        #screens-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; pointer-events: none; }
        
        .screen { 
            position: absolute; top:0; left:0; width:100%; height:100%; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            background: rgba(0,0,0,0.6); opacity: 0; transition: opacity 0.3s; 
            pointer-events: none; visibility: hidden;
        }
        .screen.active { opacity: 1; pointer-events: auto; visibility: visible; }

        /* TYPOGRAPHY & MENU */
        h1 { 
            font-family: 'Carter One'; font-size: 3.5rem; color: var(--primary); 
            text-shadow: 0 0 20px rgba(255, 170, 0, 0.6); margin-bottom: 5px; line-height: 0.9; text-align: center;
        }
        .subtitle { font-size: 1rem; color: #aaa; margin-bottom: 20px; letter-spacing: 2px; text-transform: uppercase; }

        .panel { 
            background: var(--ui-bg); border: 2px solid #554433; border-top: 4px solid var(--primary);
            padding: 25px; width: 90%; max-width: 450px; border-radius: 4px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8); pointer-events: auto;
        }

        .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.9rem; }
        .stat-val { color: var(--primary); font-weight: bold; }

        button.menu-btn {
            background: linear-gradient(180deg, #ffcc44, #ff9900); border: none; border-radius: 4px;
            color: #4a3000; font-family: 'Carter One'; font-size: 1.3rem; padding: 15px; width: 100%;
            margin-top: 20px; cursor: pointer; text-transform: uppercase; box-shadow: 0 4px 0 #b36b00;
            transition: transform 0.1s; pointer-events: auto;
        }
        button.menu-btn:active { transform: translateY(4px); box-shadow: none; }
        button.secondary { background: transparent; border: 2px solid #555; color: #888; box-shadow: none; margin-top: 10px; font-size: 0.9rem; padding: 10px; }

        .level-grid { display: grid; gap: 10px; max-height: 50vh; overflow-y: auto; margin-top: 15px; }
        .level-card { 
            background: rgba(255,255,255,0.05); padding: 15px; border-left: 4px solid #555; cursor: pointer; pointer-events: auto;
            display: flex; justify-content: space-between; align-items: center; transition: 0.2s;
        }
        .level-card:hover { background: rgba(255,255,255,0.1); border-left-color: #fff; }
        .level-card.unlocked { border-left-color: var(--primary); }
        .level-card.locked { opacity: 0.4; pointer-events: none; filter: grayscale(1); }

        /* DIALOGUE */
        #dialogue-box {
            position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 600px; background: rgba(20, 15, 10, 0.95);
            border: 2px solid #fff; padding: 25px; border-radius: 10px;
            display: none; box-shadow: 0 10px 30px #000; pointer-events: none; /* Screen intercepts clicks */
            font-size: 1.2rem; line-height: 1.5;
        }
        #dialogue-name { position: absolute; top: -15px; left: 20px; background: var(--primary); color: #000; padding: 2px 10px; font-family: 'Carter One'; border-radius: 4px; }
        .tap-hint { position: absolute; bottom: 10px; right: 20px; font-size: 0.8rem; color: #aaa; font-family: 'Carter One'; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }

        /* GAME UI (HUD & CONTROLS) */
        #game-ui { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 15; 
            opacity: 0; transition: opacity 0.3s; pointer-events: none; 
        }
        #game-ui.active { opacity: 1; pointer-events: auto; }

        #hud-top {
            position: absolute; top: 0; left: 0; width: 100%; padding: 20px; box-sizing: border-box;
            display: flex; justify-content: space-between; pointer-events: none;
            font-family: 'Carter One'; font-size: 1.5rem; text-shadow: 2px 2px 0 rgba(0,0,0,0.8);
        }
        #hud-hp-bar { width: 150px; height: 15px; background: #333; border: 2px solid #fff; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        #hud-hp-fill { width: 100%; height: 100%; background: var(--primary); transition: width 0.2s; }

        /* FIXED CONTROLS */
        #joystick-base {
            position: absolute; bottom: 40px; left: 40px; width: 140px; height: 140px;
            background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%; pointer-events: auto; touch-action: none;
        }
        #joystick-knob {
            position: absolute; top: 50%; left: 50%; width: 60px; height: 60px;
            background: rgba(255, 170, 0, 0.5); border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.8);
            transform: translate(-50%, -50%); box-shadow: 0 0 15px var(--primary); pointer-events: none;
        }

        .action-btn {
            position: absolute; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-family: 'Carter One'; font-size: 1.2rem; pointer-events: auto; cursor: pointer; touch-action: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); border: 2px solid #fff; color: white; text-shadow: 1px 1px 0 #000;
            user-select: none; -webkit-user-select: none;
        }
        #btn-fire { bottom: 40px; right: 40px; width: 100px; height: 100px; background: radial-gradient(circle, #ff5555, #aa0000); border-color: #ffaaaa; }
        #btn-fire:active, #btn-fire.pressed { transform: scale(0.95); background: #ff0000; box-shadow: 0 0 30px #ff0000; }
        
        #btn-scope { bottom: 160px; right: 60px; width: 60px; height: 60px; font-size: 0.8rem; background: radial-gradient(circle, #00ccff, #0055aa); border-color: #aaddff; }
        #btn-scope:active { transform: scale(0.95); background: #00ffff; box-shadow: 0 0 20px #00ffff; }

        /* FX OVERLAYS */
        #flash { position: absolute; top:0; left:0; width:100%; height:100%; background: #fff; opacity: 0; pointer-events: none; transition: opacity 0.05s; mix-blend-mode: overlay; z-index: 5; }
        #damage { position: absolute; top:0; left:0; width:100%; height:100%; background: radial-gradient(transparent 40%, rgba(255,0,0,0.6)); opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 5; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div style="color:var(--primary); font-family:'Carter One';">INITIALIZING SECURE LINK...</div>
    </div>

    <div id="canvas-container"></div>
    <div id="scanlines"></div>
    <div id="flash"></div>
    <div id="damage"></div>

    <!-- GAME UI LAYER (Fixed Controls) -->
    <div id="game-ui">
        <div id="hud-top">
            <div style="display:flex; flex-direction:column;">
                <span style="font-size:0.8rem; color:#aaa;">HULL INTEGRITY</span>
                <div id="hud-hp-bar"><div id="hud-hp-fill"></div></div>
            </div>
            <div style="text-align:right;">
                <span style="font-size:0.8rem; color:#aaa;">OBJECTIVE</span><br>
                <span id="hud-obj" style="color:var(--accent)">0/0</span>
            </div>
        </div>
        
        <div id="joystick-base"><div id="joystick-knob"></div></div>
        <div id="btn-fire" class="action-btn">FIRE</div>
        <div id="btn-scope" class="action-btn">SCOPE</div>
    </div>

    <!-- SCREENS LAYER (Menus & Cutscenes) -->
    <div id="screens-layer">
        
        <div id="menu-screen" class="screen active">
            <div>
                <h1>OTTER<br>ELITE FORCE</h1>
                <div class="subtitle">1.0 GOLD MASTER</div>
            </div>
            <div class="panel">
                <div class="stat-row"><span>OPERATIVE</span><span class="stat-val">SGT. BUBBLES</span></div>
                <div class="stat-row"><span>RANK</span><span class="stat-val" id="menu-rank">PUP</span></div>
                <div class="stat-row"><span>MEDALS</span><span class="stat-val" id="menu-medals">0</span></div>
                <button id="btn-campaign" class="menu-btn">CAMPAIGN</button>
                <button id="btn-reset" class="menu-btn secondary">ERASE DATA</button>
            </div>
        </div>

        <div id="level-screen" class="screen">
            <div class="panel">
                <h2 style="margin:0 0 10px 0; text-align:center; font-family:'Carter One'; color:var(--primary)">MISSIONS</h2>
                <div class="level-grid" id="level-list"></div>
                <button id="btn-back-menu" class="menu-btn secondary" style="margin-top:15px">BACK TO BASE</button>
            </div>
        </div>

        <!-- Tapping anywhere on this screen advances dialogue -->
        <div id="cutscene-screen" class="screen interactive" style="background:rgba(0,0,0,0.2); cursor:pointer;">
            <div id="dialogue-box">
                <div id="dialogue-name">GEN. WHISKERS</div>
                <div id="dialogue-text">...</div>
                <div class="tap-hint">TAP SCREEN TO CONTINUE</div>
            </div>
        </div>

    </div>

    <!-- ENGINE MODULE -->
    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';

        // --- SAFETY LOADER ---
        setTimeout(() => {
            const l = document.getElementById('loader');
            if(l) l.style.display = 'none';
        }, 2000);

        // --- CONSTANTS ---
        const LEVELS = [
            { id: 0, title: "SUNRISE PATROL", desc: "Clear visibility. Eliminate early patrols.", goal: 5, sky: 0x87CEEB, fog: 0x99ddff },
            { id: 1, title: "MUDDY DEPTHS", desc: "Heavy Gator presence. Watch the water.", goal: 12, sky: 0x557766, fog: 0x668877 },
            { id: 2, title: "THE HIVE", desc: "Destroy the Iron Scale Elite Guard.", goal: 20, sky: 0x332244, fog: 0x443355 }
        ];
        const RANKS = ["PUP", "ENSIGN", "LIEUTENANT", "COMMANDER", "ADMIRAL OF THE RIVER"];

        // --- STATE SYSTEM ---
        const State = {
            data: { rank:0, xp:0, medals:0, unlocked:1 },
            levelIdx: 0,
            load: function() { 
                try { const s = localStorage.getItem('otter_gm'); if(s) this.data = JSON.parse(s); } catch(e) {}
            },
            save: function() { 
                try { localStorage.setItem('otter_gm', JSON.stringify(this.data)); } catch(e){} 
            },
            reset: () => { 
                try { localStorage.removeItem('otter_gm'); } catch(e){} 
                location.reload(); 
            },
            gainXP: function(amt) { 
                this.data.xp += amt; 
                if(this.data.xp > (this.data.rank+1)*200) this.data.rank = Math.min(this.data.rank+1, RANKS.length-1); 
                this.save(); 
            },
            winLevel: function(idx) { 
                if(idx+1 >= this.data.unlocked) { 
                    this.data.unlocked = Math.min(idx+2, LEVELS.length); 
                    this.data.medals++; 
                } 
                this.save(); 
            }
        };

        // --- GLOBALS ---
        let scene, camera, renderer, clock;
        let player, commander, chopper, flag;
        let projectiles = [], enemies = [], pickups = [];
        // Input state derived strictly from UI elements
        let input = { move: { x: 0, y: 0 }, fire: false, zoom: false };
        let gameActive = false, mode = 'MENU';
        let dialogueQueue = [];
        let health = 100, kills = 0, lastFireTime = 0;
        let audioCtx; 

        // --- AUDIO ENGINE ---
        function initAudio() {
            try {
                if(!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if(audioCtx.state === 'suspended') audioCtx.resume();
            } catch(e) { console.warn("Audio Context Failed"); }
        }
        window.addEventListener('pointerdown', initAudio, {once:true});

        function sfx(type) {
            if(!audioCtx || audioCtx.state !== 'running') return;
            const t = audioCtx.currentTime;
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            
            if(type==='shoot') {
                o.type='sawtooth'; o.frequency.setValueAtTime(150, t); o.frequency.exponentialRampToValueAtTime(40, t+0.1);
                g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.1);
                o.start(t); o.stop(t+0.1);
            } else if(type==='hit') {
                o.type='square'; o.frequency.setValueAtTime(150, t); o.frequency.linearRampToValueAtTime(50, t+0.1);
                g.gain.setValueAtTime(0.15, t); g.gain.linearRampToValueAtTime(0, t+0.1);
                o.start(t); o.stop(t+0.1);
            } else if(type==='pickup') {
                o.type='sine'; o.frequency.setValueAtTime(600, t); o.frequency.linearRampToValueAtTime(1200, t+0.2);
                g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.2);
                o.start(t); o.stop(t+0.2);
            }
        }

        // --- PROCEDURAL ASSETS ---
        function createRig(role) {
            const grp = new THREE.Group();
            const matFur = new THREE.MeshStandardMaterial({color:0x8B5A2B, roughness:0.9});
            const matVest = new THREE.MeshStandardMaterial({color: role==='player'?0x2c3e50:0x34495e, roughness:0.6});
            
            const torso = new THREE.Mesh(new THREE.CylinderGeometry(0.5,0.45,1.4,8), matFur); 
            torso.position.y=0.7; torso.castShadow=true; grp.add(torso);
            torso.add(new THREE.Mesh(new THREE.CylinderGeometry(0.52,0.5,0.8,8), matVest));

            const head = new THREE.Mesh(new THREE.SphereGeometry(0.45,16,16), matFur); 
            head.position.y=1.45; grp.add(head);
            const snout = new THREE.Mesh(new THREE.SphereGeometry(0.25,12,12), new THREE.MeshStandardMaterial({color:0xD2B48C}));
            snout.position.set(0,-0.1,0.35); snout.scale.set(1,0.8,1.2); head.add(snout);

            if(role === 'player') {
                const band = new THREE.Mesh(new THREE.TorusGeometry(0.42,0.08,6,12), new THREE.MeshStandardMaterial({color:0xe74c3c}));
                band.rotation.x=Math.PI/2; band.position.y=0.25; head.add(band);
                const pack = new THREE.Mesh(new THREE.BoxGeometry(0.6,0.8,0.3), new THREE.MeshStandardMaterial({color:0x3e2723}));
                pack.position.set(0,0.2,-0.4); torso.add(pack);
            } else {
                const beret = new THREE.Mesh(new THREE.CylinderGeometry(0.45,0.5,0.2,8), new THREE.MeshStandardMaterial({color:0x880000}));
                beret.position.set(0,0.35,0); beret.rotation.z=-0.2; head.add(beret);
            }

            const limbGeo = new THREE.CapsuleGeometry(0.13,0.6,4,8);
            const armL = new THREE.Mesh(limbGeo, matFur); armL.position.set(-0.65,1,0); armL.rotation.z=0.4; grp.add(armL);
            const armRGrp = new THREE.Group(); armRGrp.position.set(0.65,1,0); grp.add(armRGrp);
            const armR = new THREE.Mesh(limbGeo, matFur); armR.rotation.x=-Math.PI/2; armR.position.z=0.3; armRGrp.add(armR);
            const legL = new THREE.Mesh(limbGeo, matFur); legL.position.set(-0.3,0.3,0); grp.add(legL);
            const legR = new THREE.Mesh(limbGeo, matFur); legR.position.set(0.3,0.3,0); grp.add(legR);

            if(role==='player') {
                const gun = new THREE.Group(); gun.position.set(0,0,0.8); armRGrp.add(gun);
                gun.add(new THREE.Mesh(new THREE.BoxGeometry(0.2,0.2,1.2), new THREE.MeshStandardMaterial({color:0x222, metalness: 0.5})));
            }

            grp.userData.joints = {head, armR:armRGrp, legL, legR};
            return grp;
        }

        function createGator(isHeavy) {
            const grp = new THREE.Group();
            const color = isHeavy ? 0x2b3a2b : 0x4a5d23;
            const mat = new THREE.MeshStandardMaterial({color: color, roughness: 0.8});
            
            // Body
            const body = new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.6, 2.0), mat);
            body.position.y = 0.4;
            body.castShadow = true;
            grp.add(body);
            
            // Snout
            const snout = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.4, 1.5), mat);
            snout.position.set(0, 0.3, 1.75);
            snout.castShadow = true;
            grp.add(snout);
            
            // Eyes
            const eyeMat = new THREE.MeshBasicMaterial({color: isHeavy ? 0xff3300 : 0xffff00});
            const eyeL = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.2, 0.2), eyeMat);
            eyeL.position.set(-0.3, 0.6, 1.2);
            grp.add(eyeL);
            const eyeR = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.2, 0.2), eyeMat);
            eyeR.position.set(0.3, 0.6, 1.2);
            grp.add(eyeR);

            // Tail
            const tail = new THREE.Mesh(new THREE.ConeGeometry(0.4, 2.0, 4), mat);
            tail.rotation.x = -Math.PI / 2;
            tail.position.set(0, 0.4, -2.0);
            grp.add(tail);

            // Spikes
            const spikes = new THREE.Mesh(new THREE.ConeGeometry(0.2, 0.4, 4), mat);
            spikes.position.set(0, 0.8, 0);
            grp.add(spikes);

            // Legs
            const legGeo = new THREE.BoxGeometry(0.3, 0.5, 0.3);
            const legFL = new THREE.Mesh(legGeo, mat); legFL.position.set(-0.7, 0.25, 0.8); grp.add(legFL);
            const legFR = new THREE.Mesh(legGeo, mat); legFR.position.set(0.7, 0.25, 0.8); grp.add(legFR);
            const legBL = new THREE.Mesh(legGeo, mat); legBL.position.set(-0.7, 0.25, -0.8); grp.add(legBL);
            const legBR = new THREE.Mesh(legGeo, mat); legBR.position.set(0.7, 0.25, -0.8); grp.add(legBR);

            grp.userData = { tail, legFL, legFR, legBL, legBR };
            
            const wrapper = new THREE.Group();
            wrapper.add(grp);
            if (isHeavy) wrapper.scale.set(1.4, 1.4, 1.4);
            wrapper.userData = grp.userData; 
            return wrapper;
        }

        // --- SHADERS ---
        const FLAG_VERT = `varying vec2 vUv; uniform float time; void main() { vUv = uv; vec3 p = position; float wave = sin(uv.x*5.0 - time*2.0)*0.3 + sin(uv.y*3.0 + time)*0.1; p.z += wave * uv.x; gl_Position = projectionMatrix * modelViewMatrix * vec4(p, 1.0); }`;
        const FLAG_FRAG = `varying vec2 vUv; void main() { vec3 teal = vec3(0.0, 0.7, 0.8); vec3 orange = vec3(1.0, 0.7, 0.0); vec3 white = vec3(1.0); vec3 col = teal; float d = distance(vUv, vec2(0.5)); if(d < 0.35) col = white; if(d < 0.30) col = orange; if(vUv.y < 0.2 || vUv.y > 0.8) col = vec3(0.1, 0.3, 0.4); gl_FragColor = vec4(col, 1.0); }`;
        const WATER_VERT = `varying vec2 vUv; uniform float time; void main() { vUv = uv; vec3 p = position; p.z += sin(p.x*0.5 + time)*0.2 + cos(p.y*0.3 + time*0.8)*0.2; gl_Position = projectionMatrix * modelViewMatrix * vec4(p, 1.0); }`;
        const WATER_FRAG = `varying vec2 vUv; uniform float time; void main() { vec3 water = vec3(0.15, 0.3, 0.25); vec3 foam = vec3(0.4, 0.5, 0.4); float f = sin(vUv.x*20.0 + time*2.0) + cos(vUv.y*15.0 + time); vec3 col = mix(water, foam, smoothstep(1.5, 2.0, f)); gl_FragColor = vec4(col, 0.9); }`;
        const SKY_VERT = `varying vec3 vWorldPosition; void main() { vec4 worldPosition = modelMatrix * vec4(position, 1.0); vWorldPosition = worldPosition.xyz; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`;
        const SKY_FRAG = `varying vec3 vWorldPosition; uniform vec3 topColor; uniform vec3 bottomColor; void main() { float h = normalize(vWorldPosition + vec3(0, 50.0, 0)).y; gl_FragColor = vec4(mix(bottomColor, topColor, max(h, 0.0)), 1.0); }`;

        // --- GAME LOGIC ---
        function spawnEnemy() {
            const isHeavy = Math.random() > 0.8;
            const e = createGator(isHeavy);
            const ang = Math.random()*Math.PI*2;
            const dist = 40 + Math.random()*30;
            e.position.set(player.position.x+Math.cos(ang)*dist, 0, player.position.z+Math.sin(ang)*dist);
            e.userData.hp = isHeavy ? 6 : 3;
            e.userData.speed = isHeavy ? 4 : 7;
            scene.add(e); enemies.push(e);
        }

        function spawnPickup(pos) {
            const geo = new THREE.DodecahedronGeometry(0.5);
            const mat = new THREE.MeshBasicMaterial({color:0x00ffff});
            const p = new THREE.Mesh(geo, mat);
            p.position.copy(pos); p.position.y = 1;
            scene.add(p); pickups.push(p);
        }

        function updateGame(dt, t) {
            // MOVEMENT (Relative to Camera)
            const camDir = new THREE.Vector3(); camera.getWorldDirection(camDir); camDir.y=0; camDir.normalize();
            const camSide = new THREE.Vector3().crossVectors(camDir, new THREE.Vector3(0,1,0));
            const moveVec = new THREE.Vector3();
            if(Math.abs(input.move.y)>0.1) moveVec.add(camDir.clone().multiplyScalar(-input.move.y));
            if(Math.abs(input.move.x)>0.1) moveVec.add(camSide.clone().multiplyScalar(input.move.x));

            // SMART AUTO-AIM
            let target = null;
            let minDist = 40; 
            
            if (input.fire) {
                enemies.forEach(e => {
                    const dist = player.position.distanceTo(e.position);
                    if (dist < minDist) { minDist = dist; target = e; }
                });
            }

            if (input.fire && target) {
                // Combat Stance: Snap to Target
                const targetAng = Math.atan2(target.position.x - player.position.x, target.position.z - player.position.z);
                const diff = targetAng - player.rotation.y;
                const d = ((diff + Math.PI)%(Math.PI*2)) - Math.PI;
                player.rotation.y += d * 15 * dt; // Fast snap
                
                if(moveVec.lengthSq()>0.01) player.position.add(moveVec.normalize().multiplyScalar(6*dt)); // Tactical Strafe
            } else {
                // Free Run
                if(moveVec.lengthSq()>0.01) {
                    const targetAng = Math.atan2(moveVec.x, moveVec.z);
                    const diff = targetAng - player.rotation.y;
                    const d = ((diff + Math.PI)%(Math.PI*2)) - Math.PI;
                    player.rotation.y += d * 10 * dt;
                    player.position.add(moveVec.normalize().multiplyScalar(12*dt)); // Sprint
                }
            }

            // BOUNDS
            const bounds = 190;
            player.position.x = Math.max(-bounds, Math.min(bounds, player.position.x));
            player.position.z = Math.max(-bounds, Math.min(bounds, player.position.z));

            // ANIMATION
            if(moveVec.lengthSq()>0.01) {
                player.userData.joints.legL.rotation.x = Math.sin(t*15)*0.8;
                player.userData.joints.legR.rotation.x = Math.sin(t*15+Math.PI)*0.8;
            } else {
                player.userData.joints.legL.rotation.x = 0; player.userData.joints.legR.rotation.x = 0;
            }

            // DYNAMIC CAMERA
            const targetDist = input.zoom ? 8 : 15;
            const targetHeight = input.zoom ? 4 : 8;
            
            // Camera smoothly chases player, orienting based on player's facing direction
            const off = new THREE.Vector3(0, targetHeight, -targetDist); // -Z is behind player since player faces +Z
            off.applyAxisAngle(new THREE.Vector3(0,1,0), player.rotation.y);
            
            const idealCamPos = player.position.clone().add(off);
            camera.position.lerp(idealCamPos, 0.1);
            camera.lookAt(player.position.clone().add(new THREE.Vector3(0, 2, 0)));

            // SHOOTING
            if(input.fire && (t - lastFireTime > 0.15)) {
                lastFireTime = t;
                const b = new THREE.Mesh(new THREE.BoxGeometry(0.15,0.15,1.5), new THREE.MeshBasicMaterial({color:0xffaa00}));
                b.position.copy(player.position).add(new THREE.Vector3(0,1.2,0));
                
                // Vector Forward (+Z) rotated by Player's Y rotation
                const v = new THREE.Vector3(0,0,1).applyAxisAngle(new THREE.Vector3(0,1,0), player.rotation.y);
                projectiles.push({m:b, v:v.multiplyScalar(3.0), life:40});
                scene.add(b);
                sfx('shoot');
                
                const f = document.getElementById('flash');
                f.style.opacity = 0.15; setTimeout(()=>f.style.opacity=0, 50);
            }

            // PHYSICS
            for(let i=projectiles.length-1; i>=0; i--) {
                const p = projectiles[i]; p.m.position.add(p.v); p.life--;
                for(let j=enemies.length-1; j>=0; j--) {
                    if(p.m.position.distanceTo(enemies[j].position)<2.5) { // Wider hitbox for gators
                        enemies[j].userData.hp--;
                        sfx('hit');
                        
                        // Hit Flash logic
                        enemies[j].children[0].material.emissive = new THREE.Color(0xaa0000);
                        setTimeout(()=>{if(enemies[j])enemies[j].children[0].material.emissive=new THREE.Color(0x000000)},50);
                        
                        if(enemies[j].userData.hp<=0) {
                            spawnPickup(enemies[j].position);
                            scene.remove(enemies[j]); enemies.splice(j,1);
                            kills++; State.data.kills++;
                            document.getElementById('hud-obj').innerText = `${kills}/${LEVELS[State.levelIdx].goal}`;
                            if(kills >= LEVELS[State.levelIdx].goal) {
                                State.winLevel(State.levelIdx);
                                alert("SECTOR CLEARED. RETURNING TO BASE.");
                                buildMainMenu();
                            }
                        }
                        p.life=0;
                    }
                }
                if(p.life<=0){scene.remove(p.m); projectiles.splice(i,1);}
            }

            if(enemies.length < 6 && Math.random()<0.02) spawnEnemy();
            
            enemies.forEach(e => {
                e.lookAt(player.position); 
                e.translateZ(e.userData.speed*dt);
                
                // GATOR ANIM
                if(e.userData.tail) {
                    const walkCycle = t * e.userData.speed * 2;
                    e.userData.tail.rotation.z = Math.sin(walkCycle) * 0.4;
                    e.userData.legFL.rotation.x = Math.sin(walkCycle) * 0.5;
                    e.userData.legBR.rotation.x = Math.sin(walkCycle) * 0.5;
                    e.userData.legFR.rotation.x = Math.sin(walkCycle + Math.PI) * 0.5;
                    e.userData.legBL.rotation.x = Math.sin(walkCycle + Math.PI) * 0.5;
                }

                if(e.position.distanceTo(player.position)<2.0) {
                    health -= 1;
                    document.getElementById('hud-hp-fill').style.width = `${Math.max(0, health)}%`;
                    document.getElementById('damage').style.opacity = 0.8;
                    setTimeout(()=>document.getElementById('damage').style.opacity=0, 100);
                    if(health<=0) { alert("OPERATIVE KIA."); buildMainMenu(); }
                }
            });

            for(let i=pickups.length-1; i>=0; i--) {
                const p = pickups[i]; p.rotation.y += 0.05; p.position.y = 1 + Math.sin(t*5)*0.2;
                if(p.position.distanceTo(player.position)<2.5) {
                    health = Math.min(100, health+20);
                    document.getElementById('hud-hp-fill').style.width = `${health}%`;
                    State.gainXP(50);
                    sfx('pickup');
                    scene.remove(p); pickups.splice(i,1);
                }
            }
        }

        // --- SCENE & UI ROUTES ---
        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            if(id) {
                const screen = document.getElementById(id);
                if(screen) screen.classList.add('active');
            }
        }

        function createSky(topC, botC) {
            const geo = new THREE.SphereGeometry(400, 32, 15);
            const mat = new THREE.ShaderMaterial({
                uniforms: { topColor: { value: new THREE.Color(topC) }, bottomColor: { value: new THREE.Color(botC) } },
                vertexShader: SKY_VERT, fragmentShader: SKY_FRAG, side: THREE.BackSide
            });
            return new THREE.Mesh(geo, mat);
        }

        function buildMainMenu() {
            try {
                mode = 'MENU'; switchScreen('menu-screen'); gameActive = false;
                document.getElementById('game-ui').classList.remove('active');
                document.getElementById('menu-rank').innerText = RANKS[State.data.rank];
                document.getElementById('menu-medals').innerText = State.data.medals;

                scene.clear();
                scene.add(createSky(0x331100, 0xffaa55));
                scene.fog = new THREE.Fog(0xffaa55, 30, 200); 
                
                const fl = new THREE.Mesh(new THREE.PlaneGeometry(200,200), new THREE.MeshStandardMaterial({color:0x334422}));
                fl.rotation.x=-Math.PI/2; scene.add(fl);

                player = createRig('player'); player.position.set(2,0,2); player.rotation.y=-0.5; scene.add(player);
                
                const fire = new THREE.PointLight(0xffaa00, 2, 15); fire.position.set(0,1,3); scene.add(fire);
                scene.add(new THREE.DirectionalLight(0xffcc88, 1.2));
                scene.add(new THREE.HemisphereLight(0xffaa55, 0x445533, 0.6)); 
                
                flag = new THREE.Mesh(new THREE.PlaneGeometry(6,4,10,10), new THREE.ShaderMaterial({uniforms:{time:{value:0}}, vertexShader:FLAG_VERT, fragmentShader:FLAG_FRAG, side:THREE.DoubleSide}));
                flag.position.set(0,4,-5); scene.add(flag);
                const pole = new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.1,8), new THREE.MeshStandardMaterial({color:0x888}));
                pole.position.set(-3,4,-5); scene.add(pole);

                camera.position.set(0, 6, 16); camera.lookAt(0, 2, 0);
            } catch(e) { console.error(e); }
        }

        function startLevel(idx) {
            initAudio();
            State.levelIdx = idx;
            mode = 'CUTSCENE'; switchScreen('cutscene-screen');
            
            const lvl = LEVELS[idx];
            scene.clear(); 
            scene.add(createSky(0x000000, lvl.sky));
            scene.fog = new THREE.Fog(lvl.fog, 60, 250); 
            
            const fl = new THREE.Mesh(new THREE.PlaneGeometry(400,400,64,64), new THREE.ShaderMaterial({uniforms:{time:{value:0}}, vertexShader:WATER_VERT, fragmentShader:WATER_FRAG}));
            fl.rotation.x=-Math.PI/2; scene.add(fl);
            scene.userData.water = fl;

            // Grid for depth perception
            const grid = new THREE.GridHelper(400, 40, 0xffffff, 0xffffff);
            grid.position.y = 0.01; grid.material.opacity = 0.1; grid.material.transparent = true;
            scene.add(grid);

            scene.add(new THREE.HemisphereLight(lvl.sky, 0x223322, 0.8)); 
            const sun = new THREE.DirectionalLight(0xffffff, 1.5); sun.position.set(-30,80,-30); sun.castShadow=true; scene.add(sun);

            player = createRig('player'); player.position.set(0,0,0); scene.add(player);
            commander = createRig('commander'); commander.position.set(2,0,1); commander.lookAt(player.position); scene.add(commander);
            
            camera.position.set(3, 5, 8); camera.lookAt(1, 1.5, 0);
            
            dialogueQueue = [`Mission: ${lvl.title}`, lvl.desc, "Good luck, Sergeant."];
            nextDialogue();
        }

        function nextDialogue() {
            const box = document.getElementById('dialogue-box');
            if(dialogueQueue.length > 0) {
                box.style.display='block';
                document.getElementById('dialogue-text').innerText = dialogueQueue.shift();
            } else {
                box.style.display='none';
                mode = 'GAME'; 
                switchScreen(null); // Clear all screens
                document.getElementById('game-ui').classList.add('active'); // Show HUD
                
                scene.remove(commander);
                health=100; kills=0; enemies=[]; projectiles=[]; pickups=[]; lastFireTime=0;
                input = { move:{x:0,y:0}, fire:false, zoom:false };
                
                player.position.set(0,0,0);
                document.getElementById('hud-obj').innerText = `0/${LEVELS[State.levelIdx].goal}`;
                document.getElementById('hud-hp-fill').style.width = "100%";
                gameActive=true;
            }
        }

        // --- INPUT & BINDINGS ---
        function initDOMBindings() {
            document.getElementById('btn-campaign').addEventListener('click', () => {
                initAudio();
                switchScreen('level-screen');
                const list = document.getElementById('level-list'); list.innerHTML='';
                LEVELS.forEach((l,i) => {
                    const d = document.createElement('div');
                    d.className = `level-card ${i<State.data.unlocked?'unlocked':'locked'}`;
                    d.innerHTML = `<div><strong>${l.title}</strong><br><small>${l.desc}</small></div><div class="medal-icon">â˜…</div>`;
                    if(i < State.data.unlocked) d.addEventListener('click', () => startLevel(i));
                    list.appendChild(d);
                });
            });
            document.getElementById('btn-reset').addEventListener('click', () => State.reset());
            document.getElementById('btn-back-menu').addEventListener('click', () => switchScreen('menu-screen'));
            document.getElementById('cutscene-screen').addEventListener('pointerdown', nextDialogue);
        }

        function initControls() {
            const jb = document.getElementById('joystick-base');
            const jk = document.getElementById('joystick-knob');
            let jTouchId = null;

            function updateJoystick(clientX, clientY) {
                if(mode!=='GAME') return;
                const rect = jb.getBoundingClientRect();
                const centerX = rect.left + rect.width/2;
                const centerY = rect.top + rect.height/2;
                let dx = clientX - centerX;
                let dy = clientY - centerY;
                const maxR = rect.width/2;
                const dist = Math.min(Math.sqrt(dx*dx + dy*dy), maxR);
                const ang = Math.atan2(dy, dx);
                
                dx = Math.cos(ang) * dist;
                dy = Math.sin(ang) * dist;
                
                jk.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
                input.move.x = dx / maxR;
                input.move.y = dy / maxR; // Negative is UP
            }
            
            jb.addEventListener('pointerdown', e => { e.preventDefault(); jTouchId = e.pointerId; jb.setPointerCapture(jTouchId); updateJoystick(e.clientX, e.clientY); });
            jb.addEventListener('pointermove', e => { if(e.pointerId === jTouchId) updateJoystick(e.clientX, e.clientY); });
            const releaseJoy = e => { if(e.pointerId === jTouchId) { jTouchId = null; jk.style.transform = `translate(-50%, -50%)`; input.move.x = 0; input.move.y = 0; } };
            jb.addEventListener('pointerup', releaseJoy); jb.addEventListener('pointercancel', releaseJoy);

            const bf = document.getElementById('btn-fire');
            bf.addEventListener('pointerdown', e => { e.preventDefault(); bf.setPointerCapture(e.pointerId); input.fire = true; bf.classList.add('pressed'); });
            const releaseFire = e => { input.fire = false; bf.classList.remove('pressed'); };
            bf.addEventListener('pointerup', releaseFire); bf.addEventListener('pointercancel', releaseFire);

            const bs = document.getElementById('btn-scope');
            bs.addEventListener('pointerdown', e => { e.preventDefault(); input.zoom = !input.zoom; });
            
            // Failsafe
            window.addEventListener('blur', () => { input.move.x=0; input.move.y=0; input.fire=false; jk.style.transform=`translate(-50%, -50%)`; bf.classList.remove('pressed'); });
        }

        // --- LOOP ---
        function loop() {
            requestAnimationFrame(loop);
            const dt = clock.getDelta(); const t = clock.getElapsedTime();
            if(mode === 'MENU') {
                if(flag) flag.material.uniforms.time.value = t;
                camera.position.x = Math.sin(t*0.2)*2; camera.lookAt(0,2,0);
            }
            else if(mode === 'GAME' && gameActive) {
                if(scene.userData.water) scene.userData.water.material.uniforms.time.value = t;
                updateGame(Math.min(dt, 0.1), t); // Cap DT to prevent physics explosions on lag spikes
            }
            else if(mode === 'CUTSCENE') {
                player.position.y = Math.sin(t*2)*0.02;
            }
            renderer.render(scene, camera);
        }

        // --- INIT ---
        try {
            State.load();
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 500);
            renderer = new THREE.WebGLRenderer({antialias:true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            clock = new THREE.Clock();

            initDOMBindings();
            initControls();

            window.addEventListener('resize', ()=>{ camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); });

            buildMainMenu();
            loop();
        } catch(e) {
            console.error("Engine Failure", e);
            document.getElementById('loader').innerHTML = "<div style='color:red; font-family:monospace;'>ENGINE FAILURE.</div>";
        }
    </script>
</body>
</html>